# test provisioning corresponding to the Vagrantfile

- hosts: all
  user: vagrant
  become: no
  become_method: sudo

  vars:
  - install_vagrant: true
  - vagrant_test_dir: ./vagrant_test
  - vagrant_box_file: debian-jessie64-libvirt.box
  
  roles:
  - { role: server-kvm } 

  tasks:
  - debug: msg="libvirt tests"
  
  - name: add vagrant til libvirt group
    become: yes
    user: name=vagrant groups=vagrant,libvirt
  
  - name: copy default key to kvm host
    authorized_key: 
      user: vagrant 
      key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
      manage_dir: yes

  - name: Checking libvirt access
    connection: local 
    command: "virsh -c qemu+ssh://vagrant@{{ ansible_default_ipv4.address }}/system list"

  - debug: msg="Running vagrant tests..."

  - name: ensuring that box is pre-downloaded
    connection: local 
    command: sh cacheBox.sh
    args:
      chdir: ./files
      creates: "{{ vagrant_box_file }}"
  
  - name: create vagrant dir
    file: path="{{vagrant_test_dir}}" state=directory mode=0755

  - name: init dir
    command: vagrant init debian/jessie64
    args:
      chdir: "{{vagrant_test_dir}}"
      creates: Vagrantfile

  - name: install box
    command: vagrant box add /vagrant/{{vagrant_box_file }} --name debian/jessie64
    
  - name: spin up vagrant machine
    command: vagrant up
    args:
      chdir: "{{vagrant_test_dir}}"

